---
title: "Explore Depth Profile of all Samples"
author: "Claudia Zirión-Martínez"
date: "2025-06-27"

fig-height: 7
fig-width: 9

format: 
  html:
    page-layout: full
---

This notebook is to explore the samples with high percent of duplication coverage or median chromosomal depth
and detect putative non-haploid samples.

It uses the `results/02.Dataset/` directory of the combined dataset right after the very first run without applying any filtering or excluding any samples. 


## Setup {#setup}

```{r, eval=FALSE, echo=FALSE}
setwd("/FastData/czirion/WeavePop_Cneoformans/analyses")
```

Libraries

```{r libraries, output=FALSE}
library(tidyverse)
library(patchwork)
library(ggbeeswarm)
library(ggnewscale)
library(RColorBrewer)
```

Paths

```{r paths}
metadata_path <-
    "../Crypto_Desjardins_Ashton/results/02.Dataset/metadata.csv"
cnv_chroms_path <-
    "../Crypto_Desjardins_Ashton/results/02.Dataset/cnv/cnv_chromosomes.tsv"
chromosomes_path <-
    "../Crypto_Desjardins_Ashton/results/02.Dataset/chromosomes.csv"
ploidy_out_path <- "results/tables/ploidy.tsv"
desjardins_non_haploids_path <- 
    "../Crypto_Desjardins/config/non_haploids.txt"
ashton_non_haploids_path <- 
    "../Crypto_Ashton/config/non_haploids.txt"
```

### Metadata

```{r, message=FALSE, warning=FALSE}
metadata <- read.delim(
    metadata_path,
    header=TRUE,
    sep=",",
    stringsAsFactor = TRUE)
chromosomes <- read.delim(
    chromosomes_path,
    header=TRUE,
    sep=",",
    stringsAsFactor = TRUE) 
```

### Depth and CNVs

```{r, message=FALSE, warning=FALSE}
cnv_chroms <- read.delim(
    cnv_chroms_path,
    header = TRUE,
    sep = "\t")%>%
    left_join(chromosomes, by = "accession")%>%
    select(sample, chromosome,cnv, norm_chrom_median, coverage_percent)%>%
    pivot_wider(
        names_from = cnv,
        values_from = coverage_percent)%>%
    select(sample, chromosome,norm_chrom_median,
        coverage_percent_duplication = duplication)

```

```{r}
ggplot(cnv_chroms, aes(x = coverage_percent_duplication, y = norm_chrom_median)) +
        geom_hline(yintercept = c(1, 2), color = "black", linetype = "solid") +
        geom_point()+
        scale_x_continuous(breaks = seq(0,100, by = 10))+
        theme_minimal() +
        theme(legend.position = "bottom", legend.direction = "vertical")+
        labs(y = "Normalized Chromosome Median",
            x = "Percent of Chromosome Covered by Duplications")
```

## Explore the metrics and plots of the samples with chromosomes above thresholds

```{r}
#| code-fold: false
coverage_threshold <- 20
depth_threshold <- 1.3
```

```{r}
cnv_chroms_subset <- filter(cnv_chroms, 
    coverage_percent_duplication >= coverage_threshold | 
    norm_chrom_median >= depth_threshold)%>%
    left_join(metadata, by = "sample")%>%
    arrange(desc(sample))
```

```{r}
image_paths_func <- function(df){
    image_paths <- df %>%
        mutate(depth_by_windows_path = 
                    paste("../../Crypto_", dataset, "/results/01.Samples/plots/", sample, "/depth_by_windows.png", sep = ""))
    return(image_paths)
}

print_plots <- function(df){
    for (sample_id in unique(df$sample)){
        dataset_id <- df %>% 
            filter(sample == sample_id) %>% 
            pull(dataset)%>%
            unique()%>%
            as.character()
        depth_by_windows_path <- image_paths %>%
            filter(sample == sample_id) %>% 
            pull(depth_by_windows_path)%>%
            unique()%>%
            as.character() 
        metrics <- df %>% 
            filter(sample == sample_id)%>%
            select(sample, chromosome, norm_chrom_median, coverage_percent_duplication)%>%
            as.data.frame()


        cat(paste0( "\n", "### ", sample_id), "\n")
        print(knitr::kable(metrics, row.names = FALSE), row.names = FALSE)
        cat(paste0("![](", depth_by_windows_path, ")", sep =""), "\n")
    }
}
```

<details>
<summary> Plots </summary>
```{r, results="asis"}
image_paths = image_paths_func(cnv_chroms_subset)
print_plots(cnv_chroms_subset)
``` 
</details>

### Define ploidy

```{r}
diploid <- c(
    "SRS885171",
    "SRS881180",
    "SRS881178",
    "SRS417659",
    "SRS417657",
    "SRS409113",
    "SRS404479",
    "SRS404447",
    "ERS542587",
    "ERS542586",
    "ERS542498",
    "ERS542490",
    "ERS542397",
    "ERS2541388",
    "ERS2541329",
    "ERS2541312",
    "ERS2541291",
    "ERS2541154",
    "ERS2541138",
    "ERS2541044",
    "ERS2541028",
    "ERS2541018",
    "ERS2540996",
    "ERS2540971",
    "ERS2540924",
    "ERS1142865",
    "ERS1142845",
    "ERS1142807",
    "ERS1142758",
    "ERS1142710"
)
```

```{r}
ploidy_df <- data.frame(sample = diploid, ploidy = "diploid")
```

```{r}
cnv_chroms_ploidy <- left_join(cnv_chroms, ploidy_df, by = "sample")
cnv_chroms_ploidy$ploidy[is.na(cnv_chroms_ploidy$ploidy)] <- "haploid"
cnv_chroms_ploidy <- left_join(cnv_chroms_ploidy, metadata, by = "sample")
```

```{r}
ggplot(cnv_chroms_ploidy, aes(x = coverage_percent_duplication, y = norm_chrom_median, color = ploidy)) +
        geom_hline(yintercept = c(1, 2), color = "black", linetype = "solid") +
        geom_hline(yintercept = depth_threshold, color = "red", linetype = "dashed")+
        geom_vline(xintercept = coverage_threshold, color = "red", linetype = "dashed")+
        geom_point()+
        scale_color_manual(name = "Ploidy", values = c("blue", "black"))+
        scale_x_continuous(breaks = seq(0,100, by = 10))+
        theme_minimal() +
        theme(legend.position = "bottom", legend.direction = "vertical")+
        labs(y = "Normalized Chromosome Median",
            x = "Percent of Chromosome Covered by Duplications")
```

### Write tables of detected ploidy

```{r}
desjardins_non_haploids <- cnv_chroms_ploidy %>%
    filter(dataset == "Desjardins", ploidy == "diploid")%>%
    select(sample)%>%
    distinct()%>%
    pull(sample)
ashton_non_haploids <- cnv_chroms_ploidy %>%
    filter(dataset == "Ashton", ploidy == "diploid")%>%
    select(sample)%>%
    distinct()%>%
    pull(sample)
```
```{r, message=FALSE, warning=FALSE}
write.table(ploidy_df, file = ploidy_out_path, sep = "\t",  quote = FALSE, row.names = FALSE)
write.table(desjardins_non_haploids, file = desjardins_non_haploids_path, sep = "\t",  quote = FALSE, row.names = FALSE, col.names = FALSE)
write.table(ashton_non_haploids, file = ashton_non_haploids_path, sep = "\t",  quote = FALSE, row.names = FALSE, col.names = FALSE)
```

